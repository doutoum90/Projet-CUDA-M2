<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Mathias DIDIER">
  <link rel="shortcut icon" href="../favicon.ico">
  
  <title>Optimisation GPU - Développement d’applications sous processeur graphique (GPU / CUDA).</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Optimisation GPU";
    var mkdocs_page_input_path = "optimisation.md";
    var mkdocs_page_url = "/optimisation/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Développement d’applications sous processeur graphique (GPU / CUDA).</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="..">Home</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../introduction/">Introduction</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../tk1/">Jetson TK1</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../connexions/">Connexions</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../cpu_gpu/">CPU/GPU</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../architecture/">Architectures</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../cuda/">CUDA</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../frameworks/">Frameworks</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../tensorflow/">Tensorflow</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../applications/">Applications</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../traitementImage/">Traitement d'image</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 current">
        <a class="current" href="./">Optimisation GPU</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#optimisation">Optimisation</a></li>
                
                    <li><a class="toctree-l4" href="#divergence-de-threads">Divergence de Threads</a></li>
                
                    <li><a class="toctree-l4" href="#memoire-coalescee">Mémoire coalescée</a></li>
                
            
                <li class="toctree-l3"><a href="#rappel">Rappel</a></li>
                
            
                <li class="toctree-l3"><a href="#deroulage-de-boucles">Deroulage de boucles</a></li>
                
            
            </ul>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../reduction/">Optimisation/Reduction</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../signRecognition/">Reconnaissance des signes</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../ressources/">Ressources</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../outils/">Outils</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../about/">About</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../sceances/">Scéances</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../installations/">Installations</a>
        
    </li>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Développement d’applications sous processeur graphique (GPU / CUDA).</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Optimisation GPU</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/matEhickey/Projet-CUDA-M2/edit/master/docs/optimisation.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="optimisation">Optimisation</h1>
<h2 id="divergence-de-threads">Divergence de Threads</h2>
<p>Les threads d'un bloc sont regroupés en warps de taille fixe pour l'exécution sur un noyau CUDA, et les threads dans un warp doivent suivre la même trajectoire d'exécution. Tous les threads doivent exécuter la même instruction en même temps. En d'autres termes, les threads ne peuvent pas diverger.</p>
<h3 id="if-then-else">IF-THEN-ELSE</h3>
<p>La construction de code la plus commune qui peut provoquer une divergence de thread sont les branchements conditionnels dans une instruction if-then-else. Si certains threads d'un seul warp sont évalués comme «vrais» et d'autres comme «faux», alors les threads «vrai» et «faux» se ramifient à des instructions différentes. Certains threads voudront passer à l'instruction 'then', tandis que d'autres 'else'.</p>
<p>Intuitivement, nous pensons que les instructions seront exécutés en parallèle. Cependant, les threads dans un block ne peut pas diverger,et donc la parrallelisation est donc impossible.CUDA a une solution de contournement qui corrige le problème, mais avec des conséquences assez négatives sur la performance.</p>
<p>Lors de l'exécution de l'instruction if-then-else, CUDA ordonne au warp d'exécuter la première partie puis de passer à la partie else. Lors de l'exécution de la premiere partie (if), tous les threads qui sont évalués à faux (else) sont désactivés. Lorsque l'exécution passe à l'état else, la situation est inversée. Les différentes instructions ne sont donc pas exécutées en parallèle, mais en série. Cette sérialisation peut entraîner une perte de performances significative.</p>
<h3 id="exemple-de-dead_lock">Exemple de dead_lock :</h3>
<pre><code>
//my_Func_then and my_Func_else are some device functions
if (threadidx.x &lt;16)
{
    myFunc_then();
    __syncthread();
}else if (threadidx &gt;=16)
{
    myFunc_else();
    __syncthread();
}

</code></pre>

<p>La première partie execute ses instruction puis attend que la seconde partie du block atteigne __syncthread(), cependant la seconde partie ne commence jamais et par conséquent empeche la cloture de la première instruction. (Nous sommes ici avec des warps de taille &gt; 16 threads).</p>
<h2 id="memoire-coalescee">Mémoire coalescée</h2>
<p>Un accès en mémoire est dit coalescé lorsque plusieurs threads d'un warp accèdent en même temps à à de la mémoire globale.
Les conditions suivantes peuvent résulter en un accès non-coalescé, le rendant donc sérializé :</p>
<ul>
<li>La mémoire n'est pas séquentielle</li>
<li>L'accès à la mémoire est faible</li>
<li>Un accès à la mémoire désaligné</li>
</ul>
<h3 id="acces-sequentiel-et-aligne">Accès séquentiel et aligné</h3>
<p>Ici l'accès est séquentiel et aligné, il est donc coalescé.</p>
<p>Accès séquentiel et aligné: <img alt="Alt" src="https://github.com/matEhickey/Projet-CUDA-M2/blob/master/Documentation/img/asa.png?raw=true" /> </p>
<h3 id="acces-aligne-mais-non-sequentiel">Accès aligné mais non séquentiel</h3>
<p>Ici l'accès n'est pas séquentiel mais aligné. Sur certaines architectures, principalement les plus anciennes ce genre d'acès ne peut pas être effectué en une seule transaction.</p>
<p>Accès aligné mais non séquentiel: <img alt="Alt" src="https://github.com/matEhickey/Projet-CUDA-M2/blob/master/Documentation/img/nca.png?raw=true" /></p>
<h3 id="acces-memoire-non-aligne">Accès mémoire non aligné</h3>
<p>Dans ce cas, l'accès à la mémoire est bien séquentiel mais non aligné, du coup il nous faut une transaction de plus pour charger la derniere valeur si l'alignement mémoire est de 128 Bytes.</p>
<h4 id="lalignement">L'alignement</h4>
<p>Les pointeurs alloués par cudaMalloc ou cudaMallocPitch sont garanti d'avoir X bytes alignés (i.e l'adresse est un multiple de X) avec X le nombre de bytes indiqué par le "Texture alignement" (deviceQuery). Pour la Jetson TK1 notre alignement est de 512 bytes.</p>
<h5 id="exemple">Exemple</h5>
<pre><code>
char *ptr1, *ptr2;

int bytes = 1;

cudaMalloc((void**)&amp;ptr1,bytes);
cudaMalloc((void**)&amp;ptr2,bytes);

</code></pre>

<p>En supossant que l'adresse retourné par ptr1 est un multiple de 512, alors l'adresse retournée dans ptr2 seras au minimun (ptr1 + 512).
Cette restriction est imposé par le device sur lequel la mémoire est alloué, principalement pour des raisons de performances.</p>
<p>Accès non aligné: <img alt="Alt" src="https://github.com/matEhickey/Projet-CUDA-M2/blob/master/Documentation/img/uma.png?raw=true" /></p>
<h5 id="exemple_1">Exemple</h5>
<p>Un accès en mémoire coalescé ressemble à ce genre de code. </p>
<pre><code>shared_memory[threadIdx.x]= global_memory[blockIdx.x*blockDim.x + threadIdx.x];
</code></pre>

<p>L'instruction suivante n'est quand à elle pas coalescée.</p>
<pre><code>stride=4;
shared_memory[threadIdx.x]= global_memory[stride*blockIdx.x*blockDim.x + threadIdx.x*stride];
</code></pre>

<h1 id="rappel">Rappel</h1>
<ul>
<li>La mémoire globale est lente, la mémoire "on-chip" est beaucoup plus rapide</li>
<li>Eviter en tout moment la divergence de threads</li>
<li>Des accès en mémoire coalescés permettent d'améliorer grandement la performance </li>
</ul>
<h1 id="deroulage-de-boucles">Deroulage de boucles</h1>
<p>Le deroulage de boucle est une technique d'optimisation consistant à améliorer la vitesse d'execution d'un programme au dépend de sa taille binaire
Cette amélioration de vitesse s'obtient en réduisant ou en élimant les actions controllant la boucle comme les pointeurs arithmétiques et les tests de fin de boucle à chaque itération,
ainsi qu'en éliminant les latences de lecture en mémoire.</p>
<p>Exemple de deroulage de boucle simple en C :</p>
<pre><code>
//boucle normale
 int x;
 for (x = 0; x &lt; 100; x++)
 {
     delete(x);
 }

//boucle déroulée
 int x; 
 for (x = 0; x &lt; 100; x += 5)
 {
     delete(x);
     delete(x + 1);
     delete(x + 2);
     delete(x + 3);
     delete(x + 4);
 }

</code></pre>

<p>Après cette modification le programme n'effectue que 20 itérations au lieu des 100 précedentes et seulement 20% des branches conditionelles seront prises.</p>
<p>Ce déroulage doit être effectué avec précaution afin que le controle de fin de boucle et le nombre d'opérations à l'intérieur de la boucle concordent :
Par exemple dans le cas ci dessus, si le nombre d'itérations n'était pas divisible par 5, le programme ne fonctionnerait pas.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../reduction/" class="btn btn-neutral float-right" title="Optimisation/Reduction">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../traitementImage/" class="btn btn-neutral" title="Traitement d'image"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/matEhickey/Projet-CUDA-M2" class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../traitementImage/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../reduction/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../js/theme.js"></script>

</body>
</html>
